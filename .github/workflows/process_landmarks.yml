name: Process NYC Landmarks Data

on:
  workflow_dispatch: # Allows manual triggering
    inputs:
      pages_to_process:
        description: 'Number of pages to fetch from API'
        required: true
        default: '1'
      parallel_workers:
        description: 'Number of parallel workers (0 for sequential)'
        required: true
        default: '2'
      recreate_index:
        description: 'Recreate Pinecone index before processing? (true/false)'
        required: false
        default: 'false'

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Adjust timeout as needed

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Match project version

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libpq-dev python3-dev poppler-utils libssl-dev tesseract-ocr libtesseract-dev
          python -m pip install --upgrade pip setuptools wheel

          # Debug information
          echo "Python version:"
          python --version
          echo "Pip version:"
          pip --version

          # Install packages in smaller groups with verbose output
          echo "Installing core dependencies..."
          pip install --no-cache-dir -v numpy tqdm requests

          echo "Installing PDF processing libraries..."
          pip install --no-cache-dir -v pdfminer.six pdfplumber PyPDF2 pypdfium2

          echo "Installing database and vector libraries..."
          pip install --no-cache-dir -v psycopg2-binary SQLAlchemy pinecone-client

          echo "Installing AI libraries..."
          pip install --no-cache-dir -v openai tiktoken

          echo "Installing remaining requirements..."
          pip install --no-cache-dir -r requirements.txt || {
            echo "::error::Requirements installation failed. Detailed error above."
            exit 1
          }

      - name: Run Landmark Processing Script
        env:
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          COREDATASTORE_API_KEY: ${{ secrets.COREDATASTORE_API_KEY }} # Provided as env var
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PINECONE_ENVIRONMENT: ${{ secrets.PINECONE_ENVIRONMENT }}
        run: |
          echo "Starting landmark processing..."
          ARGS="--pages ${{ github.event.inputs.pages_to_process }}"
          if [[ "${{ github.event.inputs.parallel_workers }}" -gt 0 ]]; then
            ARGS="$ARGS --parallel --workers ${{ github.event.inputs.parallel_workers }}"
          fi
          if [[ "${{ github.event.inputs.recreate_index }}" == "true" ]]; then
            ARGS="$ARGS --recreate-index"
          fi

          # Note: The script's --api-key argument is NOT being used here.
          # COREDATASTORE_API_KEY is only provided as an environment variable.
          # If the script specifically needs the --api-key argument, we need to adjust this step.
          python scripts/process_landmarks.py $ARGS
          echo "Landmark processing finished."
